{% extends "base.html" %}

{% block content %}
{% if message %}
    <div class="alert alert-info">{{ message }}</div>
    {% if start_date and end_date %}
        <div class="alert alert-secondary">
            <strong>üìÖ Analysis Period:</strong> {{ start_date }} to {{ end_date }}
        </div>
    {% endif %}
    <a href="{{ url_for('index') }}" class="btn btn-primary">‚Üê Back to Dashboard</a>
{% else %}
    <!-- Date Range Selector and Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 class="mb-0"><i class="fas fa-calendar-alt"></i> Analysis Period</h2>
                        <div class="d-flex align-items-center gap-2">
                            <small class="opacity-75">{{ analysis.total_activities }} activities analyzed ‚Ä¢ {{ analysis.workout_total_days_in_window }} days measured</small>
                        </div>
                    </div>

                    <form method="POST" action="{{ url_for('index') }}">
                        <!-- Quick Select Buttons -->
                        <div class="mb-3">
                            <div class="btn-group d-flex flex-wrap gap-2" role="group">
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="setDateRange(7)">Last 7 Days</button>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="setDateRange(30)">Last 30 Days</button>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="setDateRange(90)">Last 90 Days</button>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="setDateRange(180)">Last 6 Months</button>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="setDateRange(365)">Last Year</button>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="setYearToDate()">Year to Date</button>
                            </div>
                        </div>

                        <!-- Date Inputs -->
                        <div class="row align-items-end">
                            <div class="col-md-4">
                                <label for="start_date" class="form-label small opacity-75">Start Date</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}" required>
                            </div>
                            <div class="col-md-4">
                                <label for="end_date" class="form-label small opacity-75">End Date</label>
                                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}" required>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-light w-100">
                                    üìä Update Analysis
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Distribution Charts -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="chartTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="count-tab" data-bs-toggle="tab" data-bs-target="#count-chart" type="button" role="tab" aria-controls="count-chart" aria-selected="true">
                                üìä Activity Count
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="duration-tab" data-bs-toggle="tab" data-bs-target="#duration-chart" type="button" role="tab" aria-controls="duration-chart" aria-selected="false">
                                ‚è±Ô∏è Duration
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="workout-streaks-tab" data-bs-toggle="tab" data-bs-target="#workout-streaks" type="button" role="tab" aria-controls="workout-streaks" aria-selected="false">
                                üí™ Workout Heatmap
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="streaks-tab" data-bs-toggle="tab" data-bs-target="#streaks" type="button" role="tab" aria-controls="streaks" aria-selected="false">
                                üî• Running Heatmap
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="distance-tab" data-bs-toggle="tab" data-bs-target="#distance-chart" type="button" role="tab" aria-controls="distance-chart" aria-selected="false">
                                üèÉ Running Stats
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mileage-trend-tab" data-bs-toggle="tab" data-bs-target="#mileage-trend" type="button" role="tab" aria-controls="mileage-trend" aria-selected="false">
                                üìà Mileage Trend
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pace-trend-tab" data-bs-toggle="tab" data-bs-target="#pace-trend" type="button" role="tab" aria-controls="pace-trend" aria-selected="false">
                                ‚ö° Pace Trend
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="chartTabContent">
                        <div class="tab-pane fade show active" id="count-chart" role="tabpanel" aria-labelledby="count-tab">
                            <div id="activity-pie-chart"></div>
                        </div>
                        <div class="tab-pane fade" id="duration-chart" role="tabpanel" aria-labelledby="duration-tab">
                            <div id="duration-pie-chart"></div>
                        </div>
                        <div class="tab-pane fade" id="distance-chart" role="tabpanel" aria-labelledby="distance-tab">
                            {% if analysis.run_distance_distribution %}
                            <div class="row">
                                <div class="col-md-8">
                                    <div id="run-distance-chart"></div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">Running Summary</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <h2 class="text-primary mb-0">{{ analysis.total_runs }}</h2>
                                                <small class="text-muted">Total Runs</small>
                                            </div>
                                            <div class="mb-3">
                                                <h2 class="text-success mb-0">{{ analysis.runs_10k_plus }}</h2>
                                                <small class="text-muted">10K+ Runs</small>
                                            </div>
                                            <div class="mb-3">
                                                <h2 class="text-warning mb-0">{{ analysis.running_miles }}</h2>
                                                <small class="text-muted">Total Miles</small>
                                            </div>
                                            <div class="mb-3">
                                                <h2 class="text-info mb-0">{{ analysis.avg_pace_formatted }}</h2>
                                                <small class="text-muted">Avg Pace (/mi)</small>
                                            </div>
                                            <hr>
                                            <div class="mb-2">
                                                <h5 class="text-secondary mb-1">Personal Records</h5>
                                            </div>
                                            {% if analysis.best_mile_split %}
                                            <div class="mb-2">
                                                <strong class="text-danger">{{ analysis.best_mile_split }}</strong>
                                                <small class="text-muted d-block">Best Mile Split</small>
                                            </div>
                                            {% endif %}
                                            {% if analysis.fastest_10k %}
                                            <div class="mb-2">
                                                <strong class="text-success">{{ analysis.fastest_10k }}</strong>
                                                <small class="text-muted d-block">Fastest 10K</small>
                                            </div>
                                            {% endif %}
                                            {% if analysis.longest_run %}
                                            <div class="mb-2">
                                                <strong class="text-primary">{{ analysis.longest_run }}</strong>
                                                <small class="text-muted d-block">Longest Run</small>
                                            </div>
                                            {% endif %}
                                            {% if analysis.most_elevation_run %}
                                            <div class="mb-2">
                                                <strong class="text-warning">{{ analysis.most_elevation_run }}</strong>
                                                <small class="text-muted d-block">Most Elevation</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">No running activities found</p>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="mileage-trend" role="tabpanel" aria-labelledby="mileage-trend-tab">
                            {% if analysis.mileage_trend_daily %}
                            <div class="d-flex justify-content-center mb-3">
                                <div class="btn-group" role="group" aria-label="Mileage granularity">
                                    <button type="button" class="btn btn-outline-primary active" id="btn-daily">Daily</button>
                                    <button type="button" class="btn btn-outline-primary" id="btn-weekly">Weekly</button>
                                    <button type="button" class="btn btn-outline-primary" id="btn-monthly">Monthly</button>
                                </div>
                            </div>
                            <div id="mileage-trend-chart"></div>
                            <div class="mt-2 text-center">
                                <small class="text-muted">Shows per-period totals (not cumulative).</small>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">No running activities found to compute mileage trend.</p>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="pace-trend" role="tabpanel" aria-labelledby="pace-trend-tab">
                            {% if analysis.pace_trend_daily %}
                            <div class="d-flex justify-content-center mb-3">
                                <div class="btn-group" role="group" aria-label="Pace granularity">
                                    <button type="button" class="btn btn-outline-primary active" id="btn-pace-daily">Daily</button>
                                    <button type="button" class="btn btn-outline-primary" id="btn-pace-weekly">Weekly</button>
                                    <button type="button" class="btn btn-outline-primary" id="btn-pace-monthly">Monthly</button>
                                </div>
                            </div>
                            <div id="pace-trend-chart"></div>
                            <div class="mt-2 text-center">
                                <small class="text-muted">Shows average pace per period. Lower values indicate faster pace.</small>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">No running activities found to compute pace trend.</p>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="streaks" role="tabpanel" aria-labelledby="streaks-tab">
                            {% if analysis.total_runs and analysis.total_runs > 0 %}

                            <!-- Streak Timeline (one block per day) -->
                            <div class="mb-2 d-flex align-items-center justify-content-between">
                                <div class="small text-muted">Timeline</div>
                                <div class="d-flex align-items-center gap-3 small">
                                    <span class="d-inline-block rounded" style="width:14px;height:14px;background:#e0e0e0;border:1px solid #d0d0d0"></span> Non-Running
                                    <span class="d-inline-block rounded" style="width:14px;height:14px;background:#9bd3ae"></span> Easy
                                    <span class="d-inline-block rounded" style="width:14px;height:14px;background:#59a14f"></span> Moderate
                                    <span class="d-inline-block rounded" style="width:14px;height:14px;background:#2e7d32"></span> Big day
                                </div>
                            </div>
                            <div id="streak-timeline" class="border rounded p-2" style="display:flex; flex-wrap:wrap; gap:2px;"></div>

                            <div class="row text-center">
                                <div class="col-md-3 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.running_active_days }}</div>
                                        <div class="text-muted">Running Days</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.running_missed_days }}</div>
                                        <div class="text-muted">Non-Running Days</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.current_streak_days }}</div>
                                        <div class="text-muted">Current Streak</div>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.longest_gap_days }}</div>
                                        <div class="text-muted">Longest Gap</div>
                                    </div>
                                </div>
                            </div>

                            {% if analysis.gap_spans and analysis.gap_spans|length > 0 %}
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#gapDetails" aria-expanded="false" aria-controls="gapDetails">
                                    Show Gap Details
                                </button>
                                <div class="collapse mt-2" id="gapDetails">
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Gap Start</th>
                                                    <th>Gap End</th>
                                                    <th class="text-end">Days</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for gap in analysis.gap_spans %}
                                                <tr>
                                                    <td>{{ gap.start }}</td>
                                                    <td>{{ gap.end }}</td>
                                                    <td class="text-end">{{ gap.length }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <small class="text-muted">Gap days represent consecutive days with no runs within the selected period.</small>
                                </div>
                            </div>
                            {% else %}
                                <p class="text-muted mb-0">No gaps ‚Äî great consistency!</p>
                            {% endif %}
                            {% else %}
                                <p class="text-muted mb-0">No running activities in this period to compute streaks.</p>
                            {% endif %}
                        </div>

                        <!-- Workout Streaks Tab -->
                        <div class="tab-pane fade" id="workout-streaks" role="tabpanel" aria-labelledby="workout-streaks-tab">
                            {% if analysis.total_activities and analysis.total_activities > 0 %}
                            <!-- Workout Streak Header -->
                            <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 p-3 rounded" style="background: linear-gradient(90deg,#ff7b54 0%, #ffb26b 100%);">
                                <div class="d-flex align-items-center gap-3">
                                    <div style="font-size:2rem" aria-hidden="true">üí™</div>
                                    <div>
                                        <div class="fw-bold" style="font-size:1.1rem">Current Workout Streak</div>
                                        <div class="h4 mb-0">{{ analysis.workout_current_streak_days }} days</div>
                                        <small class="text-dark-50">Longest: {{ analysis.workout_longest_streak }} days</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    {% if analysis.workout_next_milestone %}
                                    <div class="small text-muted">Next milestone</div>
                                    <div class="h5 mb-0">{{ analysis.workout_next_milestone }} days</div>
                                    <small class="text-muted">in {{ analysis.workout_days_to_next_milestone }} day{{ 's' if analysis.workout_days_to_next_milestone != 1 }}{% if analysis.workout_eta_next_milestone %} ¬∑ by {{ analysis.workout_eta_next_milestone }}{% endif %}</small>
                                    {% else %}
                                    <div class="small text-muted">Milestones complete üéâ</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="alert alert-secondary py-2" role="alert">
                                This view tracks all your activities (running, cycling, workouts, etc.), showing your consistency across all workout types. It measures consecutive days with at least one activity, helping you understand your overall training commitment.
                            </div>

                            <!-- Workout Timeline -->
                            <div class="mb-2 d-flex align-items-center justify-content-between">
                                <div class="small text-muted">Activity Timeline</div>
                                <div class="d-flex align-items-center gap-3 small">
                                    <span class="d-inline-block rounded" style="width:14px;height:14px;background:#e0e0e0;border:1px solid #d0d0d0"></span> No Activity
                                    <span class="d-inline-block rounded" style="width:14px;height:14px;background:#ffd4a3"></span> &lt; 30 min
                                    <span class="d-inline-block rounded" style="width:14px;height:14px;background:#ffb26b"></span> 30 min - 1.5h
                                    <span class="d-inline-block rounded" style="width:14px;height:14px;background:#ff7b54"></span> 1.5h+
                                </div>
                            </div>
                            <div id="workout-streak-timeline" class="border rounded p-2" style="display:flex; flex-wrap:wrap; gap:2px;"></div>

                            <div class="row text-center">
                                <div class="col-md-2 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.workout_active_days }}</div>
                                        <div class="text-muted">Workout Days</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.workout_missed_days }}</div>
                                        <div class="text-muted">Missed Days</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.workout_current_streak_days }}</div>
                                        <div class="text-muted">Current Streak</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.workout_days_since_last if analysis.workout_days_since_last is not none else '‚Äî' }}</div>
                                        <div class="text-muted">Days Since Last</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.workout_longest_gap_days }}</div>
                                        <div class="text-muted">Longest Gap</div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <div>
                                        <div class="fw-bold" style="font-size: 1.75rem;">{{ analysis.workout_total_gap_days }}</div>
                                        <div class="text-muted">Total Gap Days</div>
                                    </div>
                                </div>
                            </div>

                            {% if analysis.workout_gap_spans and analysis.workout_gap_spans|length > 0 %}
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#workoutGapDetails" aria-expanded="false" aria-controls="workoutGapDetails">
                                    Show Gap Details
                                </button>
                                <div class="collapse mt-2" id="workoutGapDetails">
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Gap Start</th>
                                                    <th>Gap End</th>
                                                    <th class="text-end">Days</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for gap in analysis.workout_gap_spans %}
                                                <tr>
                                                    <td>{{ gap.start }}</td>
                                                    <td>{{ gap.end }}</td>
                                                    <td class="text-end">{{ gap.length }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <small class="text-muted">Gap days represent consecutive days with no activities within the selected period.</small>
                                </div>
                            </div>
                            {% else %}
                                <p class="text-muted mb-0">No gaps ‚Äî excellent consistency!</p>
                            {% endif %}
                            {% else %}
                                <p class="text-muted mb-0">No activities in this period to compute streaks.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        <strong>Note:</strong> Activities categorized as "Workout" in Strava are combined with "WeightTraining" due to Strava API limitations.
                    </small>
                </div>
            </div>
        </div>
    </div>


{% endif %}

<script>
// Date range helper functions
function setDateRange(days) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);

    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
}

function setYearToDate() {
    const endDate = new Date();
    const startDate = new Date(endDate.getFullYear(), 0, 1);

    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
}

{% if analysis %}
    // Render the activity count pie chart
    var pieChartData = {{ analysis.pie_chart | safe }};
    Plotly.newPlot('activity-pie-chart', pieChartData.data, pieChartData.layout, {responsive: true});

    // Render the duration pie chart
    var durationChartData = {{ analysis.duration_pie_chart | safe }};
    Plotly.newPlot('duration-pie-chart', durationChartData.data, durationChartData.layout, {responsive: true});

    // Render the run distance distribution bar chart
    {% if analysis.run_distance_distribution %}
    var runDistanceData = {{ analysis.run_distance_distribution | tojson }};
    var distanceLabels = Object.keys(runDistanceData);
    var distanceCounts = Object.values(runDistanceData);

    var barChart = {
        x: distanceLabels,
        y: distanceCounts,
        type: 'bar',
        marker: {
            color: '#667eea'
        }
    };

    var barLayout = {
        title: 'Run Distance Distribution (miles)',
        xaxis: { title: 'Distance Range (miles)' },
        yaxis: { title: 'Number of Runs' }
    };

    Plotly.newPlot('run-distance-chart', [barChart], barLayout, {responsive: true});
    {% endif %}

    // Render the mileage trend charts (toggle between daily/weekly/monthly)
    {% if analysis.mileage_trend_daily %}
    var mileageDaily = {{ analysis.mileage_trend_daily | safe }};
    var mileageWeekly = {{ analysis.mileage_trend_weekly | safe }};
    var mileageMonthly = {{ analysis.mileage_trend_monthly | safe }};

    function showMileage(figJson) {
        Plotly.newPlot('mileage-trend-chart', figJson.data, figJson.layout, {responsive: true});
    }

    // Initialize chart when tab becomes visible
    var mileageChartInitialized = false;
    var mileageTabButton = document.getElementById('mileage-trend-tab');
    if (mileageTabButton) {
        mileageTabButton.addEventListener('shown.bs.tab', function() {
            if (!mileageChartInitialized) {
                showMileage(mileageDaily);
                mileageChartInitialized = true;
            } else {
                // Resize existing chart when tab is shown
                Plotly.Plots.resize('mileage-trend-chart');
            }
        });
    }

    function setActive(btnId){
        ['btn-daily','btn-weekly','btn-monthly'].forEach(function(id){
            var el = document.getElementById(id);
            if(!el) return;
            if(id === btnId){ el.classList.add('active'); }
            else { el.classList.remove('active'); }
        });
    }

    document.getElementById('btn-daily')?.addEventListener('click', function(){ setActive('btn-daily'); showMileage(mileageDaily); });
    document.getElementById('btn-weekly')?.addEventListener('click', function(){ setActive('btn-weekly'); showMileage(mileageWeekly); });
    document.getElementById('btn-monthly')?.addEventListener('click', function(){ setActive('btn-monthly'); showMileage(mileageMonthly); });
    {% endif %}

    // Render the pace trend charts (toggle between daily/weekly/monthly)
    {% if analysis.pace_trend_daily %}
    var paceDaily = {{ analysis.pace_trend_daily | safe }};
    var paceWeekly = {{ analysis.pace_trend_weekly | safe }};
    var paceMonthly = {{ analysis.pace_trend_monthly | safe }};

    function showPace(figJson) {
        Plotly.newPlot('pace-trend-chart', figJson.data, figJson.layout, {responsive: true});
    }

    // Initialize chart when tab becomes visible
    var paceChartInitialized = false;
    var paceTabButton = document.getElementById('pace-trend-tab');
    if (paceTabButton) {
        paceTabButton.addEventListener('shown.bs.tab', function() {
            if (!paceChartInitialized) {
                showPace(paceDaily);
                paceChartInitialized = true;
            } else {
                // Resize existing chart when tab is shown
                Plotly.Plots.resize('pace-trend-chart');
            }
        });
    }

    function setActivePace(btnId){
        ['btn-pace-daily','btn-pace-weekly','btn-pace-monthly'].forEach(function(id){
            var el = document.getElementById(id);
            if(!el) return;
            if(id === btnId){ el.classList.add('active'); }
            else { el.classList.remove('active'); }
        });
    }

    document.getElementById('btn-pace-daily')?.addEventListener('click', function(){ setActivePace('btn-pace-daily'); showPace(paceDaily); });
    document.getElementById('btn-pace-weekly')?.addEventListener('click', function(){ setActivePace('btn-pace-weekly'); showPace(paceWeekly); });
    document.getElementById('btn-pace-monthly')?.addEventListener('click', function(){ setActivePace('btn-pace-monthly'); showPace(paceMonthly); });
    {% endif %}

    // Render Streak Timeline: small blocks per day, colored by miles
    {% if analysis.streak_daily_dates %}
    (function(){
        var dates = {{ analysis.streak_daily_dates | tojson }};
        var miles = {{ analysis.streak_daily_miles | tojson }};
        var container = document.getElementById('streak-timeline');
        if(!container) return;

        function colorForMiles(m){
            if(m <= 0) return '#e0e0e0';         // non-running day
            if(m < 3) return '#9bd3ae';          // easy
            if(m < 6) return '#59a14f';          // moderate
            return '#2e7d32';                    // big day
        }
        for(var i=0;i<dates.length;i++){
            var block = document.createElement('span');
            block.style.width = '14px';
            block.style.height = '14px';
            block.style.borderRadius = '3px';
            block.style.background = colorForMiles(miles[i] || 0);
            block.style.border = '1px solid rgba(0,0,0,0.06)';
            block.setAttribute('data-bs-toggle','tooltip');
            var title = dates[i] + (miles[i] && miles[i] > 0 ? (' ‚Äî ' + (miles[i].toFixed(2)) + ' mi') : ' ‚Äî Non-Running Day');
            block.setAttribute('title', title);
            container.appendChild(block);
        }
        // Activate tooltips for new elements
        if(window.bootstrap){
            var tipEls = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tipEls.forEach(function(el){ new bootstrap.Tooltip(el, {trigger:'hover focus'}); });
        }
    })();
    {% endif %}

    // Render workout streak timeline (all activities)
    {% if analysis.workout_daily_dates and analysis.workout_daily_hours %}
    (function(){
        var dates = {{ analysis.workout_daily_dates | tojson }};
        var hours = {{ analysis.workout_daily_hours | tojson }};
        var container = document.getElementById('workout-streak-timeline');
        if(!container) return;

        function colorForHours(h){
            if(h <= 0) return '#e0e0e0';         // no activity
            if(h < 0.5) return '#ffd4a3';        // < 30 min
            if(h < 1.5) return '#ffb26b';        // 30 min - 1.5 hours
            return '#ff7b54';                     // 1.5+ hours
        }
        function formatHours(h){
            if(h <= 0) return 'No Activity';
            var hours = Math.floor(h);
            var minutes = Math.round((h - hours) * 60);
            return hours + ':' + (minutes < 10 ? '0' : '') + minutes;
        }
        for(var i=0;i<dates.length;i++){
            var block = document.createElement('span');
            block.style.width = '14px';
            block.style.height = '14px';
            block.style.borderRadius = '3px';
            block.style.background = colorForHours(hours[i] || 0);
            block.style.border = '1px solid rgba(0,0,0,0.06)';
            block.setAttribute('data-bs-toggle','tooltip');
            var title = dates[i] + ' ‚Äî ' + formatHours(hours[i] || 0);
            block.setAttribute('title', title);
            container.appendChild(block);
        }
        // Activate tooltips for new elements
        if(window.bootstrap){
            var tipEls = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tipEls.forEach(function(el){ new bootstrap.Tooltip(el, {trigger:'hover focus'}); });
        }
    })();
    {% endif %}
{% endif %}
</script>
{% endblock %}
